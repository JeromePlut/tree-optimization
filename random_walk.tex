\documentclass{article}
\usepackage{math}
\usepackage{unicode}
\usepackage[margin=20mm]{geometry}
\let\Re\undefined \DeclareMathOperator\Re{Re}
\begin{document}

\section{Generating series for random walks}

\subsection{The series counting the passage of the walk}

Let~$W(a→^{ℓ} b)$ be the set of paths of steps in~$±1$
which start at a value~$a ∈ ℤ$ and end at~$b ∈ ℤ$
after exactly~$ℓ$ steps (i.e. they do not meet $b$~before).
(obviously, this set is non-empty only for $a+b+ℓ$~even
and~$\abs{a-b} ≤ ℓ$).

\paragraph{The main generating series.}
Fix integers~$0 ≤ s ≤ b$ and~$ℓ ≥ 0$ and define
\begin{align}
f_{s,b,ℓ}(z) = ∑_{w ∈ W(s→^{ℓ} [0,b])} ∑_{m ∈ w} z^m.
\end{align}
This polynomial counts how many times each value in~$[0,b]$
is reached by the walk~$w$.
Since each walk finally reaches exactly once the values~$0$ or~$b$,
the cardinality of~$W(s→^{ℓ} [0,b])$ is~$[z^0 + z^b] f_{s,b,ℓ}(z)$.
Moreover, looking at the first term of any walk in~$W(…)$
we find the following relation:
\begin{align}\label{eq:sum-walks}
f_{s,b,ℓ}(z)
	&= z^s \quad\text{when $s = 0$ or~$s = b$,}\\
	&= z^s + f_{s-1,b,ℓ-1}(z) + f_{s+1,b,ℓ-1}(z)
	\quad\text{when $s ∈ ⟦1,b-1⟧$.}
\end{align}
Define the formal series~$F_{s,b}(x,z) = ∑_{ℓ} f_{s,b,ℓ} x^{ℓ}$;
then the relations from~\eqref{eq:sum-walks} collect into
the following recurrence relation and boundary conditions:
\begin{align}\label{eq:recurrence-F}
F_{s,b}(x,z)
&= z^s + \begin{cases}
0 &\text{for $s ∈ \acco{0,b}$,}\\
x \pa{F_{s-1,b}(x,z) + F_{s+1,b}(x,z)} & \text{for~$s ∈ ⟦1,b-1⟧$.}\end{cases}
\end{align}

Let~$M_{b}$ be the $(b+1)× (b+1)$ square matrix
whose coefficient~$(i, i±1)$ is~$1$ for~$i = 2, …, b$;
then the relations~\eqref{eq:recurrence-F} are, in matrix form,
\begin{align}\label{eq:matrix-F}
(1 - x M_b) \mat{F_{0,b} \\ ⋮ \\ F_{b,b}} &= \mat{1 \\⋮\\z^b}.
\end{align}
% M=b->matrix(b+1,b+1,i,j,(i>1)&&(i<b+1)&&(abs(i-j)==1))
% F=(s,b)->((1-x*M(b))^-1*vector(b+1,i,z^(i-1))~)[s+1]

We observe moreover that,
for any~$b ≥ ℓ + s$, $f_{s,b,ℓ} = f_{s,s+ℓ,ℓ}$
(namely, in this case no walk can reach the value~$b$).

Assume for simplicity that $b$~is odd, and let
\begin{align}
% P_b &= \mat{
% 0 & ⋯ & 0 & 1 & 1 \\
%  & (\sin jkπ/b) && i & -i \\
% 0 & … & 0 & ⋮ & ⋮\\}
P_b &= \mat{0 ⋯ 0 &⋮&⋮\\(\sin(jkπ/b)) & i^j &(-i)^j\\0⋯0&⋮&⋮}
\end{align}
% P=b->local(w=Mod('w,polcyclo(2*b,'w)));matrix(b+1,b+1,i,j,if(j==b,I^(i-1),if(j==b+1,I^(1-i),if(i>=2&&i<=b,(w^((i-1)*j)-w^-((i-1)*j))/(2*I)))))
% S=(b,x)->x*(1-x^b)/(1-x)
% \\ T=b->local(q=b/2/P(b));vector(b-1,j,q[j,1]+q[j,b+1]*I^b+S(b-1,I*W(b)^j)/(2*I)-S(b-1,I/W(b)^j)/(2*I))
% K=(b,x)->-S(b-1,I*x)/2/I+S(b-1,I/x)/(2*I)
% T=b->local(q=b/2/P(b));vector(b-1,j,q[j,1]+q[j,b+1]*I^b-K(b,W(b)^j))
% K2=(b,x)->(-I*(x-1/x)+I^b*(x^b-x^-b)+I^(b-1)*(x^(b-1)-x^(1-b)))/(2*(x+1/x))


(that is, the two last columns of~$P_b$ are the powers of~$±i$,
while the $(b-1)$ first columns have first and last rows equal to zero
and the other rows are $(\sin(jkπ/b))$).
Then one checks that
\begin{align}
P_b^{-1} ⋅ M_b ⋅ P_b &= \mathrm{diag}((2\cos jπ/b)_{j=1:b-1}…, 0, 0);\\
P_b^{-1} &= \mat{
(\frac 1b\tan \frac{jπ}{b}) & (\frac 2b \sin \frac{jkπ}{b})
	& (\frac{(-1)^{j-1}}{b}\tan \frac{jπ}{b})\\
% (a_j) & (-\sin(jkπ/b)) & (a'_j)\\
1/2 & 0⋯0 & -i^b/2 \\
1/2 & 0⋯0 & i^b/2\\}
\end{align}
% P1=b->matrix(b+1,b+1,i,j,if(j==b,I^(i-1),if(j==b+1,I^(1-i),if(i>1&&i<=b,sin((i-1)*j*Pi/b)))))
% Q1=b->matrix(b+1,b+1,i,j,if(j==1,if(i<b,tan(i*Pi/b),b/2),if(j==b+1,if(i<b,(-1)^(i-1)*tan(i*Pi/b),(-1)^i*b/2*I^b),if(i<b,2*sin(i*(j-1)*Pi/b)))))

% Let~$a_1, …, a_{b-1}, a'_1, …, a'_{b-1}$ be the vertical side
% coefficients of~$2b\,P_b^{-1}$.
% The vertical side coefficients of~$2b\,P_{b}^{-1}$ are defined by
% \begin{align}
% a_j + i^b a'_j
% &= - ∑_{k=1}^{b-1} i^k \sin(jkπ/b) \\
% &= -\frac{1}{2i} ∑_{k=1}^{b-1} (i ω^j)^k - (i ω^{-j})^k,
% 	\quad ω = e^{iπ/b}\\
% &=\frac{1}{2} \frac{-i(ω^j-ω^{-j})+i^{b-1}(ω^{j(b-1)}-ω^{j(1-b)}) +
% i^b(ω^{jb}-ω^{-jb})}{ω^j+ω^{-j}}\\
% &=\frac{-i+i^{b-1}}{2} \frac{ω^j-ω^{-j}}{ω^j+ω^{-j}}
% % &=\frac{1}{2}(1+i^b) \tan \frac{jπ}{b}.
% % &=i^{b-1} \tan (b-1)jπ/b + i^b \tan jπ/b - i \tan jπ/b\\
% \end{align}
% Hence $a_j = \tan \frac{jπ}{b}$
% and $a'_j = (-1)^j \tan \frac{jπ}{b}$.

Thus, with $F_b$ and~$Z_b$ being the two matrices of~\eqref{eq:matrix-F},
\begin{align}
F_b
&= (1 - x M_b)^{-1} Z_b\\
&= P_b (1 - x Δ_b)^{-1} P_b^{-1} Z_b
\end{align}

% Let~$ω = \exp \frac{jπ}{b}$.
Using the relation
\begin{align}
∑_{k=1}^{b-1} \frac{2}{b} \sin \frac{jkπ}{b} z^k
&=
% &= \frac{2}{2ib} ∑_{k=1}^{b-1} z^k\pa{ω^k-ω^{-k}}\\
% &= \frac{1}{ib} ∑_{k=0}^{b-1} z^k\pa{ω^k-ω^{-k}}\\
% &= -\frac{i}{b} \pa{\frac{1-(zω)^b}{1-zω}-\frac{1-(z/ω)^b}{1-z/ω}}\\
% &= -\frac{i}{b} \frac{(1-z/ω)(1-(zω)^b) - (1-zω)(1-(z/ω)^b)}{(1-zω)(1-z/ω)}\\
% &= -\frac{i}{b} \frac{1-z/ω-ω^b z^b +ω^{b-1}z^{b+1}
% 	-1+zω+z^b/ω^b-ω^{1-b}z^{b+1}}{1-(ω+1/ω)+z^2}\\
% &= -\frac{i}{b} \frac{z^{b+1}(ω^{b-1}-ω^{1-b}) + z(ω-1/ω)}{1-(ω+1/ω)z+z^2}\\
% &= -\frac{i}{b} (ω-ω^{-1}) \frac{z-(-1)^j z^{b+1}}{1-(ω+1/ω) z + z^2}\\
&= \frac{2}{b} \sin \frac{jπ}{b} \frac{z-(-1)^j z^{b+1}}
	{1-2\cos \frac{jπ}{b} z + z^2}\\
% &= \frac{2}{2ib}
% 	\pa{z ω \frac{1-(z ω)^{b-1}}{1-zω} - z/ω \frac{1-(z/ω)^{b-1}}{1-z/ω}}\\
% &= \frac{zω(1-z/ω)(1-(zω)^{b-1}) - z/ω(1-zω)(1-(z/ω)^{b-1})}
% 	{ib(1-zω)(1-z/ω)}\\
% &= -\frac{i}{b} \frac{(zω-z^2)(1-(zω)^{b-1}) - (z/ω-z^2)(1-(z/ω)^{b-1})}
% 	{1-z(ω+1/ω)+z^2}\\
% &= -\frac ib z\frac{(-z+ω)(1-(zω)^{b-1}) - (-z+1/ω)(1-(z/ω)^{b-1})}
% 	{1-z(ω+1/ω)+z^2}\\
% &= -\frac ib z\frac{z^b(ω^{b-1}-ω^{1-b}) + z^{b-1}(-ω^b+ω^{-b})
% 	+ z(-1+1) + ω-1/ω}{1-z(ω+1/ω)+z^2}\\
% &= -\frac ib z\frac{(z^b+1)(ω-1/ω)}{1-z(ω+1/ω)+z^2}\\
% &= -\frac 2b \sin \pa{\frac{jπ}{b}}  \frac{z(z^b+1)}{1-2z \cos
% \frac{jπ}{b} + z^2}\\
\end{align}
we see that
\begin{align}
P_b^{-1} Z_b
&= \mat{\frac 1b \pa{\tan \frac{jπ}{b} (1-(-1)^j z^b)
	+ 2 \sin \frac{jπ}{b} z \frac{1-(-1)^j z^b}{1-2\cos
	\frac{jπ}{b}z+z^2}}_{j=1:b-1} \\
	\frac 12 \pa{1-(iz)^b}\\
	\frac 12 \pa{1+(iz)^b}}\\
&= \mat{\frac 1b \pa{(1-(-1)^j z^b}
	\pa{\tan \frac{jπ}{b} + 2 \frac{\sin \frac{jπ}{b}}{1-2\cos \frac{jπ}{b}
	z + z^2}}\\
	\frac 12 \pa{1-(iz)^b}\\
	\frac 12 \pa{1+(iz)^b}}\\
&= \mat{\frac 1b \tan \frac{jπ}{b}
\frac{(1-(-1)^j z^b)(1+z^2)}{1-2\cos\frac{jπ}{b} z + z^2}\\
	\frac 12 \pa{1-(iz)^b}\\
	\frac 12 \pa{1+(iz)^b}};\\
(1-x Δ_b)^{-1} P_b^{-1} Z_b
&= \mat{\frac 1b \frac{\tan \frac{jπ}{b}}{1-2x \cos\frac{jπ}{b}}
\frac{(1-(-1)^j z^b)(1+z^2)}{1-2\cos\frac{jπ}{b} z + z^2}\\
	\frac 12 \pa{1-(iz)^b}\\
	\frac 12 \pa{1+(iz)^b}};\\
F_{j,b} &=
∑_{k=1}^{b-1}\frac{\frac 1b \sin \frac{jkπ}{b}
\tan \frac{kπ}{b}}{1-2x\cos\frac{kπ}{b}}
\frac{(1-(-1)^k z^b)(1+z^2)}{1-2\cos\frac{kπ}{b}z+z^2}
+ i^j \frac{1+(-1)^j-(iz)^b+(-1)^j(iz)^b}{2}
\end{align}
For~$j = 0$ we do find~$F_{0,b} = 1$
and likewise (since we assumed $b$~odd) $F_{b,b} = z^b$.


\subsection{Extracting information from the series}

From the series~$F_{j,b}(x,z)$ we can recover the following information:
\begin{enumerate}
\item the cardinality~$N_{j,b,ℓ}$ of~$W(s→^{ℓ}[0,b])$:
since each walk passes exactly once by either~$0$ or~$b$,
we find
\begin{align}
N_{j,b}(x) = ∑ N_{j,b,ℓ} x^{ℓ} = [z^0 + z^b] F_{j,b}.
\end{align}
Moreover, by symmetry of the random walk,
$[z^b] F_{j,b} = [z^0] F_{b-j,b}$, so that
\begin{align}
N_{j,b}(x) = F_{j,b}(x,0) + F_{b-j,b}(x,0).
\end{align}
\item the probability~$P_{j,b,ℓ}$ that
a (balanced) random walk has length~$ℓ$:
it is exactly $(1/2)^{ℓ} N_{j,b,ℓ}$,
which generate the series~$P_{j,b}(x) = N_{j,b}(x/2)$.
\item given an integer~$ℓ$ and a value~$a ∈ [0,b]$,
the expected number of times a random element of~$W(ℓ)$
takes the value~$a$ is~$[z^a]$
is $[z^a] F_{j,b,ℓ}/N_{j,b,ℓ}$.
\item the probability that any random step of a walk of length~$ℓ$
takes the value~$a$
is~$[z^a] \frac{1}{ℓ+1} F_{j,b,ℓ}/N_{j,b,ℓ}$.
\item the probability that a random step of a random walk is~$a$
is~$S_{j,b}(a) = ∑_{ℓ} 2^{-ℓ} [z^a] F_{j,b,ℓ}/(ℓ+1)$.
Together these numbers generate the series
\begin{align}
S_{j,b}(z) = ∑_{a} S_{j,b}(a) z^a
 = ∑_{ℓ} \frac{1}{ℓ+1} F_{j,b,ℓ}(z)
 = 2 ∫_{0}^{1/2} F_{j,b}(x,z) d x.
\end{align}
\end{enumerate}

\paragraph{Computing.}
We compute the limit of~$S_{j,b}(z)$:
using $∫ \frac{d x}{1- c x} = -\frac{1}{c} \ln(1-c x)$,
we find
\begin{align}
S_{j,b}(z)
&= 2 ∑_{k=1}^{b-1}
	\pa{\frac 1b \sin \frac{jkπ}{b} \tan \frac{kπ}{b}}
	\frac{(1-(-1)^k z^b)(1+z^2)}{1-2 \cos \frac{kπ}{b} z + z^2}
	∫_{0}^{1/2} \frac{d x}{1- 2 x \cos \frac{kπ}{b}}
	+ \Re(i^j(1+(z/i)^b))\\
&= - ∑_{k=1}^{b-1}
	\pa{\frac 1b \sin \frac{jkπ}{b} \tan \frac{kπ}{b}}
	\frac{\ln(1- 2 \cos \frac{kπ}{b})}{\cos \frac{kπ}{b}}
	\frac{(1-(-1)^k z^b)(1+z^2)}{1-2 \cos \frac{kπ}{b} z + z^2}
	+ \Re(i^j) + \Re(i^{j-b}) z^b
\end{align}

\paragraph{Limit for~$b$.}
For~$b → ∞$ and~$\abs{z}<1$ (and thus $z^b → 0$),
the function~$S_{j,b}(z)$ is a Riemann sum:
\begin{align}
S_{j,b}(z)
&→ -\frac{1+z^2}{π} ∫_{0}^{π}
	\frac{\sin(jθ) \tan(θ) \ln(1-2\cos θ)}{\cos θ}
	+ \Re(i^j)\\
\end{align}

the limit of~$F_{j,b}(x,z)$ is given as a Riemann sum by:
\begin{align}
F_{j,b}(x,z)
&→ \frac{1+z^2}{π} ∫_{0}^{π}
	\frac{\sin(j θ) \tan(θ)}{(1-2x\cos(θ))(1-2z\cos(θ)+z^2)} d θ
	+ \mathrm{Re}(i^j)
\end{align}

Using
\begin{align}
\frac{1}{1-2x \cos θ}
&= ∑_{ℓ} (2x \cos θ)^ℓ;\\
\frac{1}{1-2z\cos(θ)+z^2}
&= \frac{1}{e^{iθ}-e^{-iθ}}
	\pa{\frac{e^{iθ}} {1-e^{iθ} z} -\frac{e^{-iθ}}{1-e^{-iθ}z}}\\
&= \frac{1}{e^{iθ}-e^{-iθ}}
	∑_{n} \pa{e^{iθ} (e^{iθ} z)^n - e^{-iθ} (e^{-iθ} z)^n}\\
&= ∑_{n} \frac{\sin (n+1)θ}{\sin θ} z^n
\end{align}

% \begin{align}
% F_{j,b}(x,z)
% &→ \frac{1+z^2}{π} ∫_{0}^{π} \sin(j θ) \tan(θ)
% ∑_{ℓ,n} (2 \cos θ)^n \frac{\sin(n+1)θ}{\sin θ} x^{ℓ} z^n d θ
% \end{align}

\end{document}
